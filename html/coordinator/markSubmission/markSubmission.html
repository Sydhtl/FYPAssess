<!DOCTYPE html>
<html>
<head>
    <title>FYPAssess - Mark Submission</title>
    <link rel="stylesheet" href="../../../css/background.css">
    <link rel="stylesheet" href="../../../css/coordinator/dashboard.css">
    <link rel="stylesheet" href="../../../css/coordinator/markSubmission.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="mark-submission-page">

    <div id="mySidebar" class="sidebar">
        <button class="menu-icon" onclick="openNav()">â˜°</button>

        <div id="sidebarLinks">
            <a href="javascript:void(0)" class="closebtn" id="close" onclick="closeNav()">
                Close <span class="x-symbol">x</span>
            </a>

            <span id="nameSide">HI, AZRINA BINTI KAMARUDIN</span>

            <a href="#supervisorMenu" class="role-header" data-role="supervisor">
                <span class="role-text">Supervisor</span>
                <span class="arrow-container">
                    <i class="bi bi-chevron-right arrow-icon"></i>
                </span>
            </a>

            <div id="supervisorMenu" class="menu-items">
                <a href="#" id="NotificationSupervisor"><i class="bi bi-bell-fill icon-padding"></i> Notification</a>
                <a href="#" id="industryCollaboration"><i class="bi bi-file-earmark-text-fill icon-padding"></i> Industry Collaboration</a>
                <a href="#" id="evaluationForm"><i class="bi bi-file-earmark-text-fill icon-padding"></i> Evaluation Form</a>
                <a href="#" id="superviseesReport"><i class="bi bi-bar-chart-fill icon-padding"></i> Supervisees' Report</a>
                <a href="#" id="logbookSubmission"><i class="bi bi-calendar-check-fill icon-padding"></i> Logbook Submission</a>
            </div>

            <a href="#assessorMenu" class="role-header" data-role="assessor">
                <span class="role-text">Assessor</span>
                <span class="arrow-container">
                    <i class="bi bi-chevron-right arrow-icon"></i>
                </span>
            </a>

            <div id="assessorMenu" class="menu-items">
                <a href="#" id="DashboardAssessor"><i class="bi bi-house-fill icon-padding"></i> Dashboard</a>
                <a href="#" id="NotificationAssessor"><i class="bi bi-bell-fill icon-padding"></i> Notification</a>
                <a href="#" id="EvaluationFormAssessor"><i class="bi bi-file-earmark-text-fill icon-padding"></i> Evaluation Form</a>
            </div>

            <a href="#coordinatorMenu" class="role-header active-role menu-expanded" data-role="coordinator">
                <span class="role-text">Coordinator</span>
                <span class="arrow-container">
                    <i class="bi bi-chevron-down arrow-icon"></i>
                </span>
            </a>

            <div id="coordinatorMenu" class="menu-items expanded">
                <a href="../dashboard/dashboardCoordinator.html" id="coordinatorDashboard"><i class="bi bi-house-fill icon-padding"></i> Dashboard</a>
                <a href="../studentAssignation/studentAssignation.html" id="studentAssignation"><i class="bi bi-people-fill icon-padding"></i> Student Assignation</a>
                <a href="../learningObjective/learningObjective.html" id="learningObjective"><i class="bi bi-book-fill icon-padding"></i> Learning Objective</a>
                <a href="markSubmission.html" id="markSubmission" class="active-menu-item"><i class="bi bi-clipboard-check-fill icon-padding"></i> Mark Submission</a>
                <a href="../notification/notification.html" id="coordinatorNotification"><i class="bi bi-bell-fill icon-padding"></i> Notification</a>
                <a href="../signatureSubmission/signatureSubmission.html" id="signatureSubmission"><i class="bi bi-pen-fill icon-padding"></i> Signature Submission</a>
                <a href="../dateTimeAllocation/dateTimeAllocation.html" id="dateTimeAllocation"><i class="bi bi-calendar-event-fill icon-padding"></i> Date & Time Allocation</a>
            </div>

            <a href="../../../login/login.html" id="logout">
                <i class="bi bi-box-arrow-left" style="padding-right: 10px;"></i> Logout
            </a>
        </div>
    </div>

    <div id="containerAtas" class="containerAtas">
        <a href="../dashboard/dashboardCoordinator.html">
            <img src="../../../assets/UPMLogo.png" alt="UPM logo" width="100px" id="upm-logo">
        </a>

        <div class="header-text-group">
            <div id="module-titles">
                <div id="containerModule">Coordinator Module</div>
                <div id="containerFYPAssess">FYPAssess</div>
            </div>
            <div id="course-session">
                <div id="courseCode">SWE4949</div>
                <div id="courseSession">2024/2025 - 2</div>
            </div>
        </div>
    </div>

    <div id="main" class="main-grid">
        <h1 class="page-title">Mark Submission</h1>

        <div class="filters-section">
            <div class="filter-group">
                <label for="yearFilter">Year</label>
                <select id="yearFilter" class="filter-select">
                    <option value="2024/2025" selected>2024/2025</option>
                    <option value="2023/2024">2023/2024</option>
                    <option value="2025/2026">2025/2026</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="semesterFilter">Semester</label>
                <select id="semesterFilter" class="filter-select">
                    <option value="1">1</option>
                    <option value="2" selected>2</option>
                </select>
            </div>
        </div>

        <div class="mark-submission-container">
            <div class="tab-buttons">
                <button class="task-tab active-tab" data-tab="swe4949a">SWE4949-A</button>
                <button class="task-tab" data-tab="swe4949b">SWE4949-B</button>
            </div>

            <div class="task-list-area">
                <!-- SWE4949-A Tab -->
                <div class="task-group active" data-group="swe4949a">
                    <div class="mark-content-container">
                        <div class="container-header">
                            <div class="view-dropdown-wrapper">
                                <select class="view-dropdown" id="viewDropdownA" onchange="changeView('swe4949a', this.value)">
                                    <option value="student-overview">Student's marks overview</option>
                                    <option value="lecturer-progress">Lecturer progress</option>
                                </select>
                            </div>
                            <div class="download-actions">
                                <div class="download-dropdown">
                                    <button id="downloadButtonPdfA" class="btn-download btn-download-pdf" onclick="toggleDownloadDropdown('pdf', 'a', this)">
                                        <i class="bi bi-file-earmark-pdf"></i>
                                        <span>Download as PDF</span>
                                        <i class="bi bi-chevron-down dropdown-arrow"></i>
                                    </button>
                                    <div class="download-dropdown-menu" id="downloadDropdownPdfA">
                                        <a href="javascript:void(0)" onclick="downloadAsPDF('swe4949a', 'marks'); closeDownloadDropdown('pdf', 'a');" class="download-option pdf-option">
                                            <i class="bi bi-file-earmark-pdf"></i>
                                            <span>Download marks</span>
                                        </a>
                                        <a href="javascript:void(0)" onclick="downloadAsPDF('swe4949a', 'marks-comments'); closeDownloadDropdown('pdf', 'a');" class="download-option pdf-option">
                                            <i class="bi bi-file-earmark-pdf"></i>
                                            <span>Download marks with comments</span>
                                        </a>
                                    </div>
                                </div>
                                <div class="download-dropdown">
                                    <button id="downloadButtonExcelA" class="btn-download btn-download-excel" onclick="toggleDownloadDropdown('excel', 'a', this)">
                                        <i class="bi bi-file-earmark-excel"></i>
                                        <span>Download as Excel</span>
                                        <i class="bi bi-chevron-down dropdown-arrow"></i>
                                    </button>
                                    <div class="download-dropdown-menu" id="downloadDropdownExcelA">
                                        <a href="javascript:void(0)" onclick="downloadAsExcel('swe4949a', 'marks'); closeDownloadDropdown('excel', 'a');" class="download-option excel-option">
                                            <i class="bi bi-file-earmark-excel"></i>
                                            <span>Download marks</span>
                                        </a>
                                        <a href="javascript:void(0)" onclick="downloadAsExcel('swe4949a', 'marks-comments'); closeDownloadDropdown('excel', 'a');" class="download-option excel-option">
                                            <i class="bi bi-file-earmark-excel"></i>
                                            <span>Download marks with comments</span>
                                        </a>
                                    </div>
                                </div>
                                <div class="download-dropdown">
                                    <button id="downloadButtonNotifyA" class="btn-download btn-notify-group" onclick="toggleDownloadDropdown('notify', 'a', this)">
                                        <i class="bi bi-bell"></i>
                                        <span>Notify</span>
                                        <i class="bi bi-chevron-down dropdown-arrow"></i>
                                    </button>
                                    <div class="download-dropdown-menu" id="downloadDropdownNotifyA">
                                        <a href="javascript:void(0)" onclick="notifyGroup('swe4949a', 'assessors'); closeDownloadDropdown('notify', 'a');" class="download-option notify-option">
                                            <i class="bi bi-bell"></i>
                                            <span>Notify all assessors</span>
                                        </a>
                                        <a href="javascript:void(0)" onclick="notifyGroup('swe4949a', 'supervisors'); closeDownloadDropdown('notify', 'a');" class="download-option notify-option">
                                            <i class="bi bi-bell"></i>
                                            <span>Notify all supervisors</span>
                                        </a>
                                        <a href="javascript:void(0)" onclick="notifyGroup('swe4949a', 'both'); closeDownloadDropdown('notify', 'a');" class="download-option notify-option">
                                            <i class="bi bi-bell"></i>
                                            <span>Notify all roles</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="table-scroll-container">
                            <table class="mark-submission-table" id="markTableA">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Matric No.</th>
                                        <th>Name</th>
                                        <th>FYP Title</th>
                                        <th>Proposal Report(10%)</th>
                                        <th>Proposal Seminar Presentation(10%)</th>
                                    </tr>
                                </thead>
                                <tbody id="markTableBodyA">
                                    <!-- Table rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <div class="table-footer">
                            <div class="actions">
                                <button class="btn btn-light border" onclick="resetMarks('swe4949a')">Cancel</button>
                                <button class="btn btn-success" onclick="saveMarks('swe4949a')">Save</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SWE4949-B Tab -->
                <div class="task-group" data-group="swe4949b">
                    <div class="mark-content-container">
                        <div class="container-header">
                            <div class="view-dropdown-wrapper">
                                <select class="view-dropdown" id="viewDropdownB" onchange="changeView('swe4949b', this.value)">
                                    <option value="student-overview">Student's marks overview</option>
                                    <option value="lecturer-progress">Lecturer progress</option>
                                </select>
                            </div>
                            <div class="download-actions">
                                <div class="download-dropdown">
                                    <button id="downloadButtonPdfB" class="btn-download btn-download-pdf" onclick="toggleDownloadDropdown('pdf', 'b', this)">
                                        <i class="bi bi-file-earmark-pdf"></i>
                                        <span>Download as PDF</span>
                                        <i class="bi bi-chevron-down dropdown-arrow"></i>
                                    </button>
                                    <div class="download-dropdown-menu" id="downloadDropdownPdfB">
                                        <a href="javascript:void(0)" onclick="downloadAsPDF('swe4949b', 'marks'); closeDownloadDropdown('pdf', 'b');" class="download-option pdf-option">
                                            <i class="bi bi-file-earmark-pdf"></i>
                                            <span>Download marks</span>
                                        </a>
                                        <a href="javascript:void(0)" onclick="downloadAsPDF('swe4949b', 'marks-comments'); closeDownloadDropdown('pdf', 'b');" class="download-option pdf-option">
                                            <i class="bi bi-file-earmark-pdf"></i>
                                            <span>Download marks with comments</span>
                                        </a>
                                    </div>
                                </div>
                                <div class="download-dropdown">
                                    <button id="downloadButtonExcelB" class="btn-download btn-download-excel" onclick="toggleDownloadDropdown('excel', 'b', this)">
                                        <i class="bi bi-file-earmark-excel"></i>
                                        <span>Download as Excel</span>
                                        <i class="bi bi-chevron-down dropdown-arrow"></i>
                                    </button>
                                    <div class="download-dropdown-menu" id="downloadDropdownExcelB">
                                        <a href="javascript:void(0)" onclick="downloadAsExcel('swe4949b', 'marks'); closeDownloadDropdown('excel', 'b');" class="download-option excel-option">
                                            <i class="bi bi-file-earmark-excel"></i>
                                            <span>Download marks</span>
                                        </a>
                                        <a href="javascript:void(0)" onclick="downloadAsExcel('swe4949b', 'marks-comments'); closeDownloadDropdown('excel', 'b');" class="download-option excel-option">
                                            <i class="bi bi-file-earmark-excel"></i>
                                            <span>Download marks with comments</span>
                                        </a>
                                    </div>
                                </div>
                                <div class="download-dropdown">
                                    <button id="downloadButtonNotifyB" class="btn-download btn-notify-group" onclick="toggleDownloadDropdown('notify', 'b', this)">
                                        <i class="bi bi-bell"></i>
                                        <span>Notify</span>
                                        <i class="bi bi-chevron-down dropdown-arrow"></i>
                                    </button>
                                    <div class="download-dropdown-menu" id="downloadDropdownNotifyB">
                                        <a href="javascript:void(0)" onclick="notifyGroup('swe4949b', 'assessors'); closeDownloadDropdown('notify', 'b');" class="download-option notify-option">
                                            <i class="bi bi-bell"></i>
                                            <span>Notify all assessors</span>
                                        </a>
                                        <a href="javascript:void(0)" onclick="notifyGroup('swe4949b', 'supervisors'); closeDownloadDropdown('notify', 'b');" class="download-option notify-option">
                                            <i class="bi bi-bell"></i>
                                            <span>Notify all supervisors</span>
                                        </a>
                                        <a href="javascript:void(0)" onclick="notifyGroup('swe4949b', 'both'); closeDownloadDropdown('notify', 'b');" class="download-option notify-option">
                                            <i class="bi bi-bell"></i>
                                            <span>Notify all roles</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="table-scroll-container">
                            <table class="mark-submission-table" id="markTableB">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Matric No.</th>
                                        <th>Name</th>
                                        <th>FYP Title</th>
                                        <th>Proposal Report(10%)</th>
                                        <th>Proposal Seminar Presentation(10%)</th>
                                    </tr>
                                </thead>
                                <tbody id="markTableBodyB">
                                    <!-- Table rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <div class="table-footer">
                            <div class="actions">
                                <button class="btn btn-light border" onclick="resetMarks('swe4949b')">Cancel</button>
                                <button class="btn btn-success" onclick="saveMarks('swe4949b')">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalOverlay" class="modal-overlay" style="display:none;"></div>
    <div id="notifyModal" class="modal" style="display:none;">
        <div class="modal-content">
            <h2 id="modalTitle">Notification</h2>
            <p id="modalMessage">Notification has been sent.</p>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        const collapsedWidth = "60px";
        const expandedWidth = "250px";

        const marksData = {
            swe4949a: [
                { id: 1, matricNo: '214673', name: 'Aisyah Nur', fypTitle: 'QR Attendance System', proposalReport: 'N/A', proposalSeminar: '8.5', comments: 'Awaiting final submission' },
                { id: 2, matricNo: '214692', name: 'Hakim Firdaus', fypTitle: 'IoT Smart Farming', proposalReport: '7.1', proposalSeminar: '7.0', comments: 'Needs improvement on seminar' },
                { id: 3, matricNo: '214726', name: 'Nabila Zahra', fypTitle: 'E-Wallet App', proposalReport: '9.1', proposalSeminar: '8.1', comments: 'Good progress' },
                { id: 4, matricNo: '214673', name: 'Faris Iman', fypTitle: 'Smart Energy Monitor', proposalReport: '8.5', proposalSeminar: 'N/A', comments: 'Seminar pending' },
                { id: 5, matricNo: '214692', name: 'Siti Hajar', fypTitle: 'Food Waste App', proposalReport: 'N/A', proposalSeminar: '8.5', comments: 'Report pending' },
                { id: 6, matricNo: '214726', name: 'Amirul Danish', fypTitle: 'Gamified E-Learning', proposalReport: '7.1', proposalSeminar: '7.0', comments: 'Requires revision' },
                { id: 7, matricNo: '214673', name: 'Nurul Aina', fypTitle: 'AI Student Chatbot', proposalReport: '9.1', proposalSeminar: '8.1', comments: 'Excellent performance' },
                { id: 8, matricNo: '214692', name: 'Hafiz Rahman', fypTitle: 'Smart Parking System', proposalReport: '8.5', proposalSeminar: 'N/A', comments: 'Awaiting seminar' },
                { id: 9, matricNo: '214726', name: 'Balqis Syafiqah', fypTitle: 'Mental Health Tracker', proposalReport: '8.5', proposalSeminar: '8.1', comments: 'On track' }
            ],
            swe4949b: [
                { id: 1, matricNo: '214673', name: 'Aisyah Nur', fypTitle: 'QR Attendance System', proposalReport: 'N/A', proposalSeminar: '8.5', comments: 'Awaiting final submission' },
                { id: 2, matricNo: '214692', name: 'Hakim Firdaus', fypTitle: 'IoT Smart Farming', proposalReport: '7.1', proposalSeminar: '7.0', comments: 'Needs improvement on seminar' }
            ]
        };

        const lecturerProgressData = {
            swe4949a: [
                { 
                    id: 1, 
                    name: 'Dr. Ahmad Faiz bin Ismail', 
                    supervisorProgress: 10, 
                    assessorProgress: 100,
                    supervisorTasks: [
                        { task: 'Proposal Report', status: 'incomplete' },
                        { task: 'Proposal Seminar', status: 'incomplete' }
                    ],
                    assessorTasks: [
                        { task: 'Proposal Report', status: 'completed' },
                        { task: 'Proposal Seminar', status: 'completed' }
                    ]
                },
                { 
                    id: 2, 
                    name: 'Prof. Madya Dr. Noraini binti Hassan', 
                    supervisorProgress: 70, 
                    assessorProgress: 10,
                    supervisorTasks: [
                        { task: 'Proposal Report', status: 'completed' },
                        { task: 'Proposal Seminar', status: 'incomplete' }
                    ],
                    assessorTasks: [
                        { task: 'Proposal Report', status: 'incomplete' },
                        { task: 'Proposal Seminar', status: 'incomplete' }
                    ]
                },
                { 
                    id: 3, 
                    name: 'Dr. Khairul Anuar bin Salleh', 
                    supervisorProgress: 19, 
                    assessorProgress: 23,
                    supervisorTasks: [
                        { task: 'Proposal Report', status: 'incomplete' },
                        { task: 'Proposal Seminar', status: 'incomplete' }
                    ],
                    assessorTasks: [
                        { task: 'Proposal Report', status: 'incomplete' },
                        { task: 'Proposal Seminar', status: 'incomplete' }
                    ]
                },
                { 
                    id: 4, 
                    name: 'Pn. Siti Mariam binti Abdullah', 
                    supervisorProgress: 69, 
                    assessorProgress: 0,
                    supervisorTasks: [
                        { task: 'Proposal Report', status: 'completed' },
                        { task: 'Proposal Seminar', status: 'incomplete' }
                    ],
                    assessorTasks: [
                        { task: 'Proposal Report', status: 'incomplete' },
                        { task: 'Proposal Seminar', status: 'incomplete' }
                    ]
                },
                { 
                    id: 5, 
                    name: 'En. Mohd Hafiz bin Omar', 
                    supervisorProgress: 67, 
                    assessorProgress: 85,
                    supervisorTasks: [
                        { task: 'Proposal Report', status: 'completed' },
                        { task: 'Proposal Seminar', status: 'incomplete' }
                    ],
                    assessorTasks: [
                        { task: 'Proposal Report', status: 'completed' },
                        { task: 'Proposal Seminar', status: 'completed' }
                    ]
                },
                { 
                    id: 6, 
                    name: 'Dr. Zulkifli bin Rahman', 
                    supervisorProgress: 70, 
                    assessorProgress: 10,
                    supervisorTasks: [
                        { task: 'Proposal Report', status: 'completed' },
                        { task: 'Proposal Seminar', status: 'incomplete' }
                    ],
                    assessorTasks: [
                        { task: 'Proposal Report', status: 'incomplete' },
                        { task: 'Proposal Seminar', status: 'incomplete' }
                    ]
                },
                { 
                    id: 7, 
                    name: 'Prof. Dr. Faridah binti Ahmad', 
                    supervisorProgress: 19, 
                    assessorProgress: 23,
                    supervisorTasks: [
                        { task: 'Proposal Report', status: 'incomplete' },
                        { task: 'Proposal Seminar', status: 'incomplete' }
                    ],
                    assessorTasks: [
                        { task: 'Proposal Report', status: 'incomplete' },
                        { task: 'Proposal Seminar', status: 'incomplete' }
                    ]
                },
                { 
                    id: 8, 
                    name: 'Pn. Nurul Aini binti Zakaria', 
                    supervisorProgress: 69, 
                    assessorProgress: 0,
                    supervisorTasks: [
                        { task: 'Proposal Report', status: 'completed' },
                        { task: 'Proposal Seminar', status: 'incomplete' }
                    ],
                    assessorTasks: [
                        { task: 'Proposal Report', status: 'incomplete' },
                        { task: 'Proposal Seminar', status: 'incomplete' }
                    ]
                },
                { 
                    id: 9, 
                    name: 'En. Syahrul Nizam bin Musa', 
                    supervisorProgress: 67, 
                    assessorProgress: 85,
                    supervisorTasks: [
                        { task: 'Proposal Report', status: 'completed' },
                        { task: 'Proposal Seminar', status: 'incomplete' }
                    ],
                    assessorTasks: [
                        { task: 'Proposal Report', status: 'completed' },
                        { task: 'Proposal Seminar', status: 'completed' }
                    ]
                }
            ],
            swe4949b: [
                { 
                    id: 1, 
                    name: 'Dr. Ahmad Faiz bin Ismail', 
                    supervisorProgress: 10, 
                    assessorProgress: 100,
                    supervisorTasks: [
                        { task: 'Proposal Report', status: 'incomplete' },
                        { task: 'Proposal Seminar', status: 'incomplete' }
                    ],
                    assessorTasks: [
                        { task: 'Proposal Report', status: 'completed' },
                        { task: 'Proposal Seminar', status: 'completed' }
                    ]
                }
            ]
        };

        const currentView = {
            swe4949a: 'student-overview',
            swe4949b: 'student-overview'
        };

        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            renderTable('swe4949a');
            renderTable('swe4949b');
            initializeRoleToggle();
            closeNav();

            const overlay = document.getElementById('modalOverlay');
            if (overlay) {
                overlay.addEventListener('click', closeModal);
            }

            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeModal();
                    closeAllDropdowns();
                }
            });
        });

        function initializeTabs() {
            const tabs = document.querySelectorAll('.task-tab');
            const taskGroups = document.querySelectorAll('.task-group');

            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const tabName = e.target.getAttribute('data-tab');
                    tabs.forEach(t => t.classList.remove('active-tab'));
                    e.target.classList.add('active-tab');
                    taskGroups.forEach(group => {
                        if (group.getAttribute('data-group') === tabName) {
                            group.classList.add('active');
                        } else {
                            group.classList.remove('active');
                        }
                    });
                    closeAllDropdowns();
                });
            });
        }

        function changeView(tabName, viewType) {
            currentView[tabName] = viewType;
            renderTable(tabName);
            closeAllDropdowns();
        }

        function formatStatus(status) {
            const normalized = (status || '').toLowerCase() === 'completed';
            return {
                text: normalized ? 'Completed' : 'Incomplete',
                className: normalized ? 'status-completed' : 'status-incomplete'
            };
        }

        function renderTable(tabName) {
            const tableIdSuffix = tabName.charAt(tabName.length - 1).toUpperCase();
            const table = document.getElementById(`markTable${tableIdSuffix}`);
            const tbody = document.getElementById(`markTableBody${tableIdSuffix}`);
            const thead = table ? table.querySelector('thead') : null;
            if (!table || !tbody || !thead) return;

            const viewType = currentView[tabName] || 'student-overview';

            if (viewType === 'lecturer-progress') {
                table.classList.add('lecturer-view');
                const data = lecturerProgressData[tabName] || [];
                thead.innerHTML = '';
                tbody.innerHTML = '';

                if (!data.length) {
                    thead.innerHTML = `
                        <tr>
                            <th>No.</th>
                            <th>Name</th>
                            <th>Progress as Supervisor(%)</th>
                            <th>Progress as Assessor(%)</th>
                            <th>Notify</th>
                        </tr>
                    `;
                    tbody.innerHTML = `<tr><td colspan="5" class="empty-state">No lecturer data available</td></tr>`;
                    return;
                }

                const supervisorTaskNames = data[0].supervisorTasks?.map(task => task.task) || ['No tasks'];
                const assessorTaskNames = data[0].assessorTasks?.map(task => task.task) || ['No tasks'];

                const headerRow = document.createElement('tr');
                headerRow.innerHTML = `
                    <th rowspan="2">No.</th>
                    <th rowspan="2">Name</th>
                    <th colspan="${supervisorTaskNames.length}">Progress as Supervisor(%)</th>
                    <th colspan="${assessorTaskNames.length}">Progress as Assessor(%)</th>
                    <th rowspan="2">Notify</th>
                `;
                thead.appendChild(headerRow);

                const subHeaderRow = document.createElement('tr');
                supervisorTaskNames.forEach(name => {
                    const th = document.createElement('th');
                    th.textContent = name;
                    subHeaderRow.appendChild(th);
                });
                assessorTaskNames.forEach(name => {
                    const th = document.createElement('th');
                    th.textContent = name;
                    subHeaderRow.appendChild(th);
                });
                thead.appendChild(subHeaderRow);

                data.forEach((item, index) => {
                    const row = document.createElement('tr');
                    let rowHTML = `<td>${index + 1}.</td><td>${item.name}</td>`;

                    const supervisorTasks = item.supervisorTasks || [];
                    supervisorTaskNames.forEach((_, taskIndex) => {
                        const task = supervisorTasks[taskIndex];
                        if (task) {
                            const statusInfo = formatStatus(task.status);
                            rowHTML += `<td><span class="status-badge ${statusInfo.className}">${statusInfo.text}</span></td>`;
                        } else {
                            rowHTML += '<td>-</td>';
                        }
                    });

                    const assessorTasks = item.assessorTasks || [];
                    assessorTaskNames.forEach((_, taskIndex) => {
                        const task = assessorTasks[taskIndex];
                        if (task) {
                            const statusInfo = formatStatus(task.status);
                            rowHTML += `<td><span class="status-badge ${statusInfo.className}">${statusInfo.text}</span></td>`;
                        } else {
                            rowHTML += '<td>-</td>';
                        }
                    });

                    rowHTML += `<td><button class="btn-notify" onclick="notifyLecturer('${tabName}', ${item.id})">Notify</button></td>`;
                    row.innerHTML = rowHTML;
                    tbody.appendChild(row);
                });
            } else {
                table.classList.remove('lecturer-view');
                const data = marksData[tabName] || [];
                thead.innerHTML = `
                    <tr>
                        <th>No.</th>
                        <th>Matric No.</th>
                        <th>Name</th>
                        <th>FYP Title</th>
                        <th>Proposal Report (10%)</th>
                        <th>Proposal Seminar Presentation (10%)</th>
                    </tr>
                `;
                tbody.innerHTML = '';

                if (!data.length) {
                    tbody.innerHTML = `<tr><td colspan="6" class="empty-state">No marks data available</td></tr>`;
                    return;
                }

                data.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}.</td>
                        <td>${item.matricNo}</td>
                        <td>${item.name}</td>
                        <td>${item.fypTitle}</td>
                        <td>${item.proposalReport}</td>
                        <td>${item.proposalSeminar}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        function notifyLecturer(tabName, lecturerId) {
            const data = lecturerProgressData[tabName] || [];
            const lecturer = data.find(item => item.id === lecturerId);
            const name = lecturer ? lecturer.name : 'the selected lecturer';
            closeAllDropdowns();
            openModal('Notification Sent', `Notification has been sent to ${name}.`);
        }

        function notifyGroup(tabName, role) {
            let roleLabel = '';
            switch (role) {
                case 'assessors':
                    roleLabel = 'all assessors';
                    break;
                case 'supervisors':
                    roleLabel = 'all supervisors';
                    break;
                default:
                    roleLabel = 'all assessors and supervisors';
            }
            closeAllDropdowns();
            openModal('Notification Sent', `Notifications have been sent to ${roleLabel} for ${tabName.toUpperCase()}.`);
        }

        function closeAllDropdowns() {
            document.querySelectorAll('.download-dropdown-menu').forEach(menu => menu.classList.remove('show'));
            document.querySelectorAll('.btn-download.active').forEach(btn => btn.classList.remove('active'));
        }

        function toggleDownloadDropdown(type, tab, button) {
            const idSuffix = `${type.charAt(0).toUpperCase() + type.slice(1)}${tab.toUpperCase()}`;
            const dropdown = document.getElementById(`downloadDropdown${idSuffix}`);
            const triggerButton = button || document.getElementById(`downloadButton${idSuffix}`);
            const wasOpen = dropdown?.classList.contains('show');

            closeAllDropdowns();

            if (dropdown && !wasOpen) {
                dropdown.classList.add('show');
                if (triggerButton) {
                    triggerButton.classList.add('active');
                }
            }
        }

        function closeDownloadDropdown() {
            closeAllDropdowns();
        }

        function buildLecturerExportRows(tabName) {
            const data = lecturerProgressData[tabName] || [];
            const supervisorTaskNames = (data[0]?.supervisorTasks?.length ? data[0].supervisorTasks.map(task => task.task) : ['No tasks']);
            const assessorTaskNames = (data[0]?.assessorTasks?.length ? data[0].assessorTasks.map(task => task.task) : ['No tasks']);
            const headers = ['No.', 'Name', ...supervisorTaskNames.map(name => `Supervisor - ${name}`), ...assessorTaskNames.map(name => `Assessor - ${name}`)];

            const rows = data.map((item, index) => {
                const supervisorTasks = supervisorTaskNames.map((_, idx) => {
                    const task = (item.supervisorTasks || [])[idx];
                    return task ? formatStatus(task.status).text : '-';
                });
                const assessorTasks = assessorTaskNames.map((_, idx) => {
                    const task = (item.assessorTasks || [])[idx];
                    return task ? formatStatus(task.status).text : '-';
                });
                return [index + 1, item.name, ...supervisorTasks, ...assessorTasks];
            });

            return { headers, rows };
        }

        function downloadAsPDF(tabName, type) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'pt', 'a4');
            const viewType = currentView[tabName];
            let head = [];
            let body = [];
            let title = '';
            let filename = '';

            if (viewType === 'lecturer-progress') {
                const exportData = buildLecturerExportRows(tabName);
                if (!exportData.rows.length) {
                    openModal('Download Failed', 'No lecturer progress data available.');
                    return;
                }
                head = [exportData.headers];
                body = exportData.rows;
                title = `Lecturer Progress (${tabName.toUpperCase()})`;
                filename = `lecturer-progress-${tabName}.pdf`;
            } else {
                const data = marksData[tabName] || [];
                if (!data.length) {
                    openModal('Download Failed', 'No marks data available.');
                    return;
                }
                const includeComments = type === 'marks-comments';
                const headers = ['No.', 'Matric No.', 'Name', 'FYP Title', 'Proposal Report (10%)', 'Proposal Seminar Presentation (10%)'];
                if (includeComments) {
                    headers.push('Comments');
                }
                head = [headers];
                body = data.map((item, index) => {
                    const row = [index + 1, item.matricNo, item.name, item.fypTitle, item.proposalReport, item.proposalSeminar];
                    if (includeComments) {
                        row.push(item.comments || '-');
                    }
                    return row;
                });
                title = `Student Marks Overview (${tabName.toUpperCase()})${includeComments ? ' - With Comments' : ''}`;
                filename = `student-marks-${tabName}${includeComments ? '-with-comments' : ''}.pdf`;
            }

            doc.setFontSize(16);
            doc.text(title, 40, 40);
            doc.autoTable({
                head,
                body,
                startY: 60,
                styles: { font: 'helvetica', fontSize: 10 },
                headStyles: { fillColor: [120, 0, 0], textColor: 255 },
                alternateRowStyles: { fillColor: [245, 234, 234] },
                margin: { left: 40, right: 40 }
            });
            doc.save(filename);
            closeAllDropdowns();
        }

        function downloadAsExcel(tabName, type) {
            const viewType = currentView[tabName];
            let headers = [];
            let rows = [];
            let filename = '';

            if (viewType === 'lecturer-progress') {
                const exportData = buildLecturerExportRows(tabName);
                if (!exportData.rows.length) {
                    openModal('Download Failed', 'No lecturer progress data available.');
                    return;
                }
                headers = exportData.headers;
                rows = exportData.rows;
                filename = `lecturer-progress-${tabName}.csv`;
            } else {
                const data = marksData[tabName] || [];
                if (!data.length) {
                    openModal('Download Failed', 'No marks data available.');
                    return;
                }
                const includeComments = type === 'marks-comments';
                headers = ['No.', 'Matric No.', 'Name', 'FYP Title', 'Proposal Report (10%)', 'Proposal Seminar Presentation (10%)'];
                if (includeComments) {
                    headers.push('Comments');
                }
                rows = data.map((item, index) => {
                    const row = [index + 1, item.matricNo, item.name, item.fypTitle, item.proposalReport, item.proposalSeminar];
                    if (includeComments) {
                        row.push(item.comments || '-');
                    }
                    return row;
                });
                filename = `student-marks-${tabName}${includeComments ? '-with-comments' : ''}.csv`;
            }

            const csvLines = [];
            const escapeValue = (value) => `"${String(value).replace(/"/g, '""')}"`;
            csvLines.push(headers.map(escapeValue).join(','));
            rows.forEach(row => {
                csvLines.push(row.map(escapeValue).join(','));
            });

            const csvContent = csvLines.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            closeAllDropdowns();
        }

        function openModal(title, message) {
            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById('notifyModal');
            const titleEl = document.getElementById('modalTitle');
            const messageEl = document.getElementById('modalMessage');
            if (!overlay || !modal) return;

            if (titleEl) titleEl.textContent = title || 'Notification';
            if (messageEl) messageEl.textContent = message || '';

            overlay.style.display = 'block';
            modal.style.display = 'block';
        }

        function closeModal() {
            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById('notifyModal');
            if (overlay) overlay.style.display = 'none';
            if (modal) modal.style.display = 'none';
        }

        function saveMarks(tabName) {
            console.log('Saving marks for', tabName);
        }

        function resetMarks(tabName) {
            console.log('Resetting marks for', tabName);
            renderTable(tabName);
        }

        function openNav() {
            const sidebar = document.getElementById("mySidebar");
            const header = document.getElementById("containerAtas");
            const mainContent = document.getElementById("main");
            const menuIcon = document.querySelector(".menu-icon");

            sidebar.style.width = expandedWidth;
            if (mainContent) mainContent.style.marginLeft = expandedWidth;
            if (header) header.style.marginLeft = expandedWidth;

            document.getElementById("nameSide").style.display = "block";

            const links = document.getElementById("sidebarLinks").getElementsByTagName("a");
            for (let i = 0; i < links.length; i++) {
                if (links[i].classList.contains('role-header') || links[i].id === 'logout') {
                    links[i].style.display = 'flex';
                } else if (links[i].id === 'close') {
                    links[i].style.display = 'flex';
                }
            }

            document.querySelectorAll('.menu-items.expanded a').forEach(a => a.style.display = 'block');

            if (menuIcon) menuIcon.style.display = "none";
        }

        function closeNav() {
            const sidebar = document.getElementById("mySidebar");
            const header = document.getElementById("containerAtas");
            const mainContent = document.getElementById("main");
            const menuIcon = document.querySelector(".menu-icon");

            sidebar.style.width = collapsedWidth;
            if (mainContent) mainContent.style.marginLeft = collapsedWidth;
            if (header) header.style.marginLeft = collapsedWidth;

            document.getElementById("nameSide").style.display = "none";

            const links = document.getElementById("sidebarLinks").getElementsByTagName("a");
            for (let i = 0; i < links.length; i++) {
                links[i].style.display = "none";
            }

            if (menuIcon) menuIcon.style.display = "block";
        }

        function initializeRoleToggle() {
            function setActiveMenuItem(menuItemId) {
                const coordinatorMenuItems = document.querySelectorAll('#coordinatorMenu a');
                coordinatorMenuItems.forEach(item => {
                    item.classList.remove('active-menu-item');
                });

                const activeItem = document.querySelector(`#${menuItemId}`);
                if (activeItem) {
                    activeItem.classList.add('active-menu-item');
                }
            }

            const allRoleHeaders = document.querySelectorAll('.role-header');
            allRoleHeaders.forEach(header => {
                if (header.getAttribute('data-role') === 'coordinator') {
                    header.classList.add('active-role');
                    header.classList.add('menu-expanded');
                } else {
                    header.classList.remove('active-role');
                    header.classList.remove('menu-expanded');
                }
            });

            setActiveMenuItem('markSubmission');

            const roleHeaders = document.querySelectorAll('.role-header');
            roleHeaders.forEach(header => {
                header.addEventListener('click', function (e) {
                    e.preventDefault();
                    const role = this.getAttribute('data-role');
                    const menuId = `${role}Menu`;
                    const menu = document.getElementById(menuId);

                    if (role === 'coordinator') {
                        if (menu) {
                            const isExpanded = menu.classList.contains('expanded');
                            if (isExpanded) {
                                menu.classList.remove('expanded');
                                this.classList.remove('menu-expanded');
                                const arrow = this.querySelector('.arrow-icon');
                                if (arrow) {
                                    arrow.classList.remove('bi-chevron-down');
                                    arrow.classList.add('bi-chevron-right');
                                }
                            } else {
                                menu.classList.add('expanded');
                                this.classList.add('menu-expanded');
                                const arrow = this.querySelector('.arrow-icon');
                                if (arrow) {
                                    arrow.classList.remove('bi-chevron-right');
                                    arrow.classList.add('bi-chevron-down');
                                }
                            }
                        }
                    } else {
                        if (menu) {
                            menu.classList.toggle('expanded');
                            const arrow = this.querySelector('.arrow-icon');
                            if (arrow) {
                                if (menu.classList.contains('expanded')) {
                                    arrow.classList.remove('bi-chevron-right');
                                    arrow.classList.add('bi-chevron-down');
                                } else {
                                    arrow.classList.remove('bi-chevron-down');
                                    arrow.classList.add('bi-chevron-right');
                                }
                            }
                        }
                    }
                });
            });
        }

        document.addEventListener('click', function(event) {
            if (!event.target.closest('.download-dropdown')) {
                closeAllDropdowns();
            }
        });
    </script>
</body>
</html>

